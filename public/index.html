<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Video Games</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <h1>Video Games</h1>
        <p class="lead">A collection of video games</p>
      </div>
    </header>

    <main class="container">
      <section class="panel">
        <div class="section-header">
          <h2>Games</h2>
          <button id="addBtn" class="btn btn-add">+ Add Game</button>
        </div>
        <div id="games" class="grid">Loading…</div>
      </section>
    </main>

    <!-- Add Game Modal -->
    <div id="addModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add New Game</h2>
        <form id="addForm">
          <input type="text" id="title" placeholder="Title" required>
          <input type="text" id="genre" placeholder="Genre">
          <input type="text" id="platform" placeholder="Platform">
          <input type="number" id="releaseYear" placeholder="Release Year">
          <input type="number" id="rating" placeholder="Rating (0-5)" step="0.1">
          <input type="number" id="price" placeholder="Price" step="0.01">
          <button type="submit" class="btn btn-submit">Add Game</button>
        </form>
      </div>
    </div>

    <footer class="site-footer">
      <div class="container">Frontend For Video Games<code>REST API</code></div>
    </footer>

    <script>
      async function fetchJson(path) {
        try {
          const res = await fetch(path)
          if (!res.ok) throw new Error(res.statusText)
          return await res.json()
        } catch (err) {
          return { error: err.message }
        }
      }

      function formatPrice(p) {
        if (p === null || p === undefined) return '—'
        return p === 0 ? 'Free' : `$${p.toFixed(2)}`
      }

      async function render() {
        const games = await fetchJson('/api/games')

        const gamesEl = document.getElementById('games')
        if (games.error) {
          gamesEl.textContent = 'Error: ' + games.error
        } else {
          gamesEl.innerHTML = ''
          games.forEach(g => {
            const div = document.createElement('div')
            div.className = 'card game-card'
            div.innerHTML = `
              <div class="game-header">
                <div class="game-title">${g.title}</div>
                <div class="game-price">${formatPrice(g.price)}</div>
              </div>
              <div class="game-meta">${g.genre || ''} • ${g.platform || ''} • ${g.release_year || g.releaseYear || ''}</div>
              <div class="game-stats">Rating: <strong>${g.rating}</strong></div>
              <button class="btn btn-delete" onclick="deleteGame(${g.id})">Delete</button>
            `
            gamesEl.appendChild(div)
          })
        }
      }

      async function deleteGame(id) {
        if (!confirm('Are you sure you want to delete this game?')) return
        try {
          const res = await fetch(`/api/games/${id}`, { method: 'DELETE' })
          if (res.ok) {
            alert('Game deleted!')
            render()
          } else {
            alert('Failed to delete game')
          }
        } catch (err) {
          alert('Error: ' + err.message)
        }
      }

      async function addGame(e) {
        e.preventDefault()
        const gameData = {
          title: document.getElementById('title').value,
          genre: document.getElementById('genre').value,
          platform: document.getElementById('platform').value,
          releaseYear: parseInt(document.getElementById('releaseYear').value) || null,
          rating: parseFloat(document.getElementById('rating').value) || null,
          price: parseFloat(document.getElementById('price').value) || null
        }

        try {
          const res = await fetch('/api/games', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gameData)
          })
          if (res.ok) {
            alert('Game added!')
            document.getElementById('addForm').reset()
            document.getElementById('addModal').style.display = 'none'
            render()
          } else {
            alert('Failed to add game')
          }
        } catch (err) {
          alert('Error: ' + err.message)
        }
      }

      // Modal controls
      const modal = document.getElementById('addModal')
      const addBtn = document.getElementById('addBtn')
      const closeBtn = document.querySelector('.close')
      const addForm = document.getElementById('addForm')

      addBtn.addEventListener('click', () => { modal.style.display = 'block' })
      closeBtn.addEventListener('click', () => { modal.style.display = 'none' })
      window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none' })
      addForm.addEventListener('submit', addGame)

      render()
    </script>
  </body>
</html>